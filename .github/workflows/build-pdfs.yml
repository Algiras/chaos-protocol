name: Build Research PDFs

on:
  push:
    branches: [main]
    paths:
      - 'research/papers/**'
  workflow_dispatch:

jobs:
  build-pdfs:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Quarto
        uses: quarto-dev/quarto-actions/setup@v2
        with:
          version: 1.4.549

      - name: Install R (for Quarto figures)
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: '4.3.2'

      - name: Install R packages
        run: |
          R -e 'install.packages(c("ggplot2", "dplyr", "tidyr", "reshape2", "gridExtra"))'

      - name: Build Whitepaper
        run: |
          cd research/papers/whitepaper
          quarto render . --to pdf

      - name: Build Proof Paper
        run: |
          cd research/papers/whitepaper
          quarto render proof-paper.qmd --to pdf

      - name: Build Investor Brief
        run: |
          cd research/papers/whitepaper
          quarto render investor-brief.qmd --to pdf

      - name: Build Litepaper
        run: |
          cd research/papers/whitepaper
          quarto render litepaper.qmd --to pdf

      - name: Copy PDFs to site/public/whitepaper
        run: |
          mkdir -p site/public/whitepaper
          cp research/papers/whitepaper/_book/CHAOS-Token--Antifragile-Volatility-Harvesting-on-Cardano.pdf site/public/whitepaper/chaos-whitepaper.pdf
          cp research/papers/whitepaper/proof-paper.pdf site/public/whitepaper/
          cp research/papers/whitepaper/investor-brief.pdf site/public/whitepaper/
          cp research/papers/whitepaper/litepaper.pdf site/public/whitepaper/

      - name: Create Release and Upload Assets
        uses: softprops/action-gh-release@v1
        with:
          tag_name: papers-${{ github.run_number }}
          name: Research Papers Build ${{ github.run_number }}
          body: |
            Automated build of research papers from commit ${{ github.sha }}

            PDFs generated:
            - CHAOS Whitepaper (193 pages)
            - Proof Paper (4 pages)
            - Investor Brief (3 pages)
            - Litepaper (1 page)
          files: |
            research/papers/whitepaper/_book/CHAOS-Token--Antifragile-Volatility-Harvesting-on-Cardano.pdf
            research/papers/whitepaper/proof-paper.pdf
            research/papers/whitepaper/investor-brief.pdf
            research/papers/whitepaper/litepaper.pdf
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
